# ğŸ’¾ Phase 1 æ•°æ®åº“ä»»åŠ¡ - AIåŸºç¡€è¡¨ç»“æ„è®¾è®¡

## ğŸ“‹ ä»»åŠ¡æ¦‚è§ˆ

**é˜¶æ®µåç§°**: Phase 1 - AIåŸºç¡€è¡¨ç»“æ„è®¾è®¡  
**ä»»åŠ¡èŒƒå›´**: D001-D005  
**é¢„è®¡æ—¶é—´**: 2å¤©  
**æ ¸å¿ƒç›®æ ‡**: è®¾è®¡æ”¯æŒAIåŠŸèƒ½çš„åŸºç¡€æ•°æ®è¡¨ç»“æ„ï¼Œç¡®ä¿å¤šç§Ÿæˆ·éš”ç¦»å’Œæ•°æ®å®‰å…¨  
**æ•°æ®åº“**: MySQL 8.0+ (ä¸»åº“) + Redis (ç¼“å­˜)

---

## ğŸ“Š ä»»åŠ¡åˆ†ç±»ç»Ÿè®¡

| ç±»åˆ« | ä»»åŠ¡æ•°é‡ | é¢„è®¡æ—¶é—´ |
|------|----------|----------|
| ä¼šè¯ç®¡ç†è¡¨ | 1ä¸ª | 0.5å¤© |
| æ¶ˆæ¯è®°å½•è¡¨ | 1ä¸ª | 0.5å¤© |
| é…ç½®ç®¡ç†è¡¨ | 1ä¸ª | 0.5å¤© |
| ç»Ÿè®¡åˆ†æè¡¨ | 1ä¸ª | 0.5å¤© |
| æƒé™é…ç½®è¡¨ | 1ä¸ª | 0.5å¤© |
| **æ€»è®¡** | **5ä¸ª** | **2.5å¤©** |

---

## ğŸ’¬ ä¼šè¯ç®¡ç†è¡¨ä»»åŠ¡ (D001)

### D001: è®¾è®¡AIèŠå¤©ä¼šè¯è¡¨ (ai_chat_session)
- **ä»»åŠ¡æè¿°**: è®¾è®¡AIèŠå¤©ä¼šè¯çš„ä¸»è¡¨ï¼Œç®¡ç†ç”¨æˆ·ä¸AIçš„å¯¹è¯ä¼šè¯
- **è¡¨ç»“æ„è®¾è®¡**:
  ```sql
  CREATE TABLE `ai_chat_session` (
    `id` BIGINT NOT NULL AUTO_INCREMENT COMMENT 'ä¼šè¯ID',
    `session_uuid` VARCHAR(64) NOT NULL COMMENT 'ä¼šè¯UUIDï¼Œç”¨äºå‰ç«¯æ ‡è¯†',
    `tenant_id` VARCHAR(64) NOT NULL DEFAULT '000000' COMMENT 'ç§Ÿæˆ·ID',
    `user_id` BIGINT NOT NULL COMMENT 'ç”¨æˆ·ID',
    `session_title` VARCHAR(255) DEFAULT NULL COMMENT 'ä¼šè¯æ ‡é¢˜',
    `model_provider` VARCHAR(32) NOT NULL COMMENT 'æ¨¡å‹æä¾›å•† (openai/azure/ollama)',
    `model_name` VARCHAR(64) NOT NULL COMMENT 'æ¨¡å‹åç§°',
    `system_prompt` TEXT COMMENT 'ç³»ç»Ÿæç¤ºè¯',
    `session_config` JSON COMMENT 'ä¼šè¯é…ç½® (temperature, max_tokensç­‰)',
    `message_count` INT DEFAULT 0 COMMENT 'æ¶ˆæ¯æ•°é‡',
    `total_tokens` INT DEFAULT 0 COMMENT 'æ€»Tokenæ¶ˆè€—',
    `status` TINYINT DEFAULT 1 COMMENT 'çŠ¶æ€ (1:æ´»è·ƒ 2:æš‚åœ 3:ç»“æŸ)',
    `created_by` BIGINT NOT NULL COMMENT 'åˆ›å»ºè€…',
    `created_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
    `updated_by` BIGINT DEFAULT NULL COMMENT 'æ›´æ–°è€…',
    `updated_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ—¶é—´',
    `deleted` TINYINT DEFAULT 0 COMMENT 'åˆ é™¤æ ‡å¿— (0:æ­£å¸¸ 1:åˆ é™¤)',
    PRIMARY KEY (`id`),
    UNIQUE KEY `uk_session_uuid` (`session_uuid`),
    KEY `idx_tenant_user` (`tenant_id`, `user_id`),
    KEY `idx_created_time` (`created_time`),
    KEY `idx_status` (`status`, `deleted`)
  ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='AIèŠå¤©ä¼šè¯è¡¨';
  ```

- **æ ¸å¿ƒå­—æ®µè¯´æ˜**:
  - `session_uuid`: å‰ç«¯ä½¿ç”¨çš„ä¼šè¯æ ‡è¯†ï¼Œé¿å…æš´éœ²å†…éƒ¨ID
  - `tenant_id`: å¤šç§Ÿæˆ·éš”ç¦»å­—æ®µï¼Œç»§æ‰¿RuoYiçš„ç§Ÿæˆ·ä½“ç³»
  - `model_provider`: æ”¯æŒå¤šç§AIæ¨¡å‹æä¾›å•†
  - `session_config`: JSONå­—æ®µå­˜å‚¨çµæ´»çš„ä¼šè¯é…ç½®
  - `total_tokens`: ç”¨äºæˆæœ¬ç»Ÿè®¡å’Œé…é¢æ§åˆ¶

- **ç´¢å¼•è®¾è®¡**:
  - ä¸»é”®ç´¢å¼•ï¼šå¿«é€Ÿå®šä½ä¼šè¯
  - ç§Ÿæˆ·ç”¨æˆ·ç´¢å¼•ï¼šæ”¯æŒå¤šç§Ÿæˆ·æŸ¥è¯¢
  - æ—¶é—´ç´¢å¼•ï¼šæ”¯æŒæ—¶é—´èŒƒå›´æŸ¥è¯¢
  - çŠ¶æ€ç´¢å¼•ï¼šæ”¯æŒçŠ¶æ€è¿‡æ»¤

- **éªŒæ”¶æ ‡å‡†**:
  - æ”¯æŒé«˜å¹¶å‘æ’å…¥å’ŒæŸ¥è¯¢
  - å¤šç§Ÿæˆ·æ•°æ®å®Œå…¨éš”ç¦»
  - è½¯åˆ é™¤æœºåˆ¶æ­£å¸¸å·¥ä½œ
  - ç´¢å¼•è¦†ç›–å¸¸ç”¨æŸ¥è¯¢åœºæ™¯

- **é¢„è®¡å·¥æ—¶**: 0.5å¤©
- **ä¾èµ–ä»»åŠ¡**: æ— 
- **è¾“å‡ºæ–‡ä»¶**: `server/script/sql/ai_chat_session.sql`

---

## ğŸ“ æ¶ˆæ¯è®°å½•è¡¨ä»»åŠ¡ (D002)

### D002: è®¾è®¡AIæ¶ˆæ¯è®°å½•è¡¨ (ai_chat_message)
- **ä»»åŠ¡æè¿°**: è®¾è®¡AIå¯¹è¯æ¶ˆæ¯çš„è¯¦ç»†è®°å½•è¡¨ï¼Œå­˜å‚¨æ¯æ¡æ¶ˆæ¯çš„å®Œæ•´ä¿¡æ¯
- **è¡¨ç»“æ„è®¾è®¡**:
  ```sql
  CREATE TABLE `ai_chat_message` (
    `id` BIGINT NOT NULL AUTO_INCREMENT COMMENT 'æ¶ˆæ¯ID',
    `message_uuid` VARCHAR(64) NOT NULL COMMENT 'æ¶ˆæ¯UUID',
    `session_id` BIGINT NOT NULL COMMENT 'ä¼šè¯ID',
    `tenant_id` VARCHAR(64) NOT NULL DEFAULT '000000' COMMENT 'ç§Ÿæˆ·ID',
    `user_id` BIGINT NOT NULL COMMENT 'ç”¨æˆ·ID',
    `message_role` VARCHAR(16) NOT NULL COMMENT 'æ¶ˆæ¯è§’è‰² (user/assistant/system)',
    `message_type` VARCHAR(16) DEFAULT 'text' COMMENT 'æ¶ˆæ¯ç±»å‹ (text/image/file/code)',
    `message_content` LONGTEXT NOT NULL COMMENT 'æ¶ˆæ¯å†…å®¹',
    `content_format` VARCHAR(16) DEFAULT 'plain' COMMENT 'å†…å®¹æ ¼å¼ (plain/markdown/json)',
    `prompt_tokens` INT DEFAULT 0 COMMENT 'è¾“å…¥Tokenæ•°',
    `completion_tokens` INT DEFAULT 0 COMMENT 'è¾“å‡ºTokenæ•°',
    `total_tokens` INT DEFAULT 0 COMMENT 'æ€»Tokenæ•°',
    `model_provider` VARCHAR(32) NOT NULL COMMENT 'æ¨¡å‹æä¾›å•†',
    `model_name` VARCHAR(64) NOT NULL COMMENT 'æ¨¡å‹åç§°',
    `model_version` VARCHAR(32) DEFAULT NULL COMMENT 'æ¨¡å‹ç‰ˆæœ¬',
    `response_time` INT DEFAULT NULL COMMENT 'å“åº”æ—¶é—´(æ¯«ç§’)',
    `finish_reason` VARCHAR(32) DEFAULT NULL COMMENT 'å®ŒæˆåŸå›  (stop/length/function_call)',
    `error_code` VARCHAR(32) DEFAULT NULL COMMENT 'é”™è¯¯ç ',
    `error_message` TEXT DEFAULT NULL COMMENT 'é”™è¯¯ä¿¡æ¯',
    `metadata` JSON DEFAULT NULL COMMENT 'æ‰©å±•å…ƒæ•°æ®',
    `parent_message_id` BIGINT DEFAULT NULL COMMENT 'çˆ¶æ¶ˆæ¯ID(ç”¨äºè¿½è¸ªå¯¹è¯é“¾)',
    `created_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
    `deleted` TINYINT DEFAULT 0 COMMENT 'åˆ é™¤æ ‡å¿— (0:æ­£å¸¸ 1:åˆ é™¤)',
    PRIMARY KEY (`id`),
    UNIQUE KEY `uk_message_uuid` (`message_uuid`),
    KEY `idx_session_id` (`session_id`),
    KEY `idx_tenant_user` (`tenant_id`, `user_id`),
    KEY `idx_created_time` (`created_time`),
    KEY `idx_message_role` (`message_role`),
    KEY `idx_parent_message` (`parent_message_id`),
    CONSTRAINT `fk_message_session` FOREIGN KEY (`session_id`) REFERENCES `ai_chat_session` (`id`) ON DELETE CASCADE
  ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='AIèŠå¤©æ¶ˆæ¯è¡¨';
  ```

- **æ ¸å¿ƒå­—æ®µè¯´æ˜**:
  - `message_role`: åŒºåˆ†ç”¨æˆ·æ¶ˆæ¯ã€AIå“åº”ã€ç³»ç»Ÿæ¶ˆæ¯
  - `message_type`: æ”¯æŒå¤šç§æ¶ˆæ¯ç±»å‹ï¼Œä¸ºæœªæ¥æ‰©å±•åšå‡†å¤‡
  - `*_tokens`: è¯¦ç»†çš„Tokenä½¿ç”¨ç»Ÿè®¡ï¼Œæ”¯æŒç²¾ç¡®è®¡è´¹
  - `response_time`: æ€§èƒ½ç›‘æ§æŒ‡æ ‡
  - `parent_message_id`: æ„å»ºæ¶ˆæ¯å¯¹è¯æ ‘ï¼Œæ”¯æŒåˆ†æ”¯å¯¹è¯

- **åˆ†åŒºç­–ç•¥**:
  ```sql
  -- æŒ‰æœˆåˆ†åŒºï¼Œæé«˜æŸ¥è¯¢æ€§èƒ½
  ALTER TABLE ai_chat_message 
  PARTITION BY RANGE (TO_DAYS(created_time)) (
    PARTITION p202501 VALUES LESS THAN (TO_DAYS('2025-02-01')),
    PARTITION p202502 VALUES LESS THAN (TO_DAYS('2025-03-01')),
    PARTITION p202503 VALUES LESS THAN (TO_DAYS('2025-04-01')),
    -- ç»§ç»­æ·»åŠ åˆ†åŒº...
    PARTITION pmax VALUES LESS THAN MAXVALUE
  );
  ```

- **éªŒæ”¶æ ‡å‡†**:
  - æ”¯æŒå¤§é‡æ¶ˆæ¯å­˜å‚¨(å•è¡¨åƒä¸‡çº§)
  - æŸ¥è¯¢æ€§èƒ½æ»¡è¶³ä¸šåŠ¡éœ€æ±‚
  - åˆ†åŒºæœºåˆ¶æ­£å¸¸å·¥ä½œ
  - å¤–é”®çº¦æŸä¿è¯æ•°æ®å®Œæ•´æ€§

- **é¢„è®¡å·¥æ—¶**: 0.5å¤©
- **ä¾èµ–ä»»åŠ¡**: D001
- **è¾“å‡ºæ–‡ä»¶**: `server/script/sql/ai_chat_message.sql`

---

## âš™ï¸ é…ç½®ç®¡ç†è¡¨ä»»åŠ¡ (D003)

### D003: è®¾è®¡AIæ¨¡å‹é…ç½®è¡¨ (ai_model_config)
- **ä»»åŠ¡æè¿°**: è®¾è®¡AIæ¨¡å‹çš„é…ç½®ç®¡ç†è¡¨ï¼Œæ”¯æŒç§Ÿæˆ·çº§åˆ«çš„æ¨¡å‹é…ç½®
- **è¡¨ç»“æ„è®¾è®¡**:
  ```sql
  CREATE TABLE `ai_model_config` (
    `id` BIGINT NOT NULL AUTO_INCREMENT COMMENT 'é…ç½®ID',
    `config_uuid` VARCHAR(64) NOT NULL COMMENT 'é…ç½®UUID',
    `tenant_id` VARCHAR(64) NOT NULL DEFAULT '000000' COMMENT 'ç§Ÿæˆ·ID',
    `config_name` VARCHAR(128) NOT NULL COMMENT 'é…ç½®åç§°',
    `config_type` VARCHAR(16) NOT NULL DEFAULT 'tenant' COMMENT 'é…ç½®ç±»å‹ (system/tenant/user)',
    `user_id` BIGINT DEFAULT NULL COMMENT 'ç”¨æˆ·ID(ç”¨æˆ·çº§é…ç½®)',
    `model_provider` VARCHAR(32) NOT NULL COMMENT 'æ¨¡å‹æä¾›å•†',
    `model_name` VARCHAR(64) NOT NULL COMMENT 'æ¨¡å‹åç§°',
    `api_endpoint` VARCHAR(512) DEFAULT NULL COMMENT 'APIç«¯ç‚¹',
    `api_key_encrypted` TEXT DEFAULT NULL COMMENT 'åŠ å¯†åçš„APIå¯†é’¥',
    `model_parameters` JSON NOT NULL COMMENT 'æ¨¡å‹å‚æ•°é…ç½®',
    `system_prompt` TEXT DEFAULT NULL COMMENT 'é»˜è®¤ç³»ç»Ÿæç¤ºè¯',
    `max_tokens_limit` INT DEFAULT 4000 COMMENT 'æœ€å¤§Tokené™åˆ¶',
    `rate_limit_rpm` INT DEFAULT 60 COMMENT 'æ¯åˆ†é’Ÿè¯·æ±‚é™åˆ¶',
    `rate_limit_tpm` INT DEFAULT 150000 COMMENT 'æ¯åˆ†é’ŸTokené™åˆ¶',
    `cost_per_1k_input` DECIMAL(10,6) DEFAULT 0.000000 COMMENT 'æ¯1Kè¾“å…¥Tokenæˆæœ¬',
    `cost_per_1k_output` DECIMAL(10,6) DEFAULT 0.000000 COMMENT 'æ¯1Kè¾“å‡ºTokenæˆæœ¬',
    `enabled` TINYINT DEFAULT 1 COMMENT 'æ˜¯å¦å¯ç”¨ (0:ç¦ç”¨ 1:å¯ç”¨)',
    `is_default` TINYINT DEFAULT 0 COMMENT 'æ˜¯å¦é»˜è®¤é…ç½® (0:å¦ 1:æ˜¯)',
    `priority` INT DEFAULT 0 COMMENT 'ä¼˜å…ˆçº§(æ•°å­—è¶Šå¤§ä¼˜å…ˆçº§è¶Šé«˜)',
    `description` VARCHAR(512) DEFAULT NULL COMMENT 'é…ç½®æè¿°',
    `created_by` BIGINT NOT NULL COMMENT 'åˆ›å»ºè€…',
    `created_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
    `updated_by` BIGINT DEFAULT NULL COMMENT 'æ›´æ–°è€…',
    `updated_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ—¶é—´',
    `deleted` TINYINT DEFAULT 0 COMMENT 'åˆ é™¤æ ‡å¿— (0:æ­£å¸¸ 1:åˆ é™¤)',
    PRIMARY KEY (`id`),
    UNIQUE KEY `uk_config_uuid` (`config_uuid`),
    UNIQUE KEY `uk_tenant_default` (`tenant_id`, `is_default`, `deleted`),
    KEY `idx_tenant_type` (`tenant_id`, `config_type`),
    KEY `idx_provider_model` (`model_provider`, `model_name`),
    KEY `idx_enabled` (`enabled`, `deleted`)
  ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='AIæ¨¡å‹é…ç½®è¡¨';
  ```

- **ç¤ºä¾‹é…ç½®æ•°æ®**:
  ```sql
  -- OpenAI GPT-4é…ç½®ç¤ºä¾‹
  INSERT INTO ai_model_config (
    config_uuid, tenant_id, config_name, model_provider, model_name,
    model_parameters, system_prompt, cost_per_1k_input, cost_per_1k_output,
    enabled, is_default, created_by
  ) VALUES (
    UUID(), '000000', 'OpenAI GPT-4o', 'openai', 'gpt-4o',
    '{"temperature": 0.7, "max_tokens": 4000, "top_p": 1.0, "frequency_penalty": 0.0, "presence_penalty": 0.0}',
    'ä½ æ˜¯ä¸€ä¸ªæœ‰ç”¨çš„AIåŠ©æ‰‹ï¼Œè¯·ç”¨ä¸­æ–‡å›ç­”é—®é¢˜ã€‚',
    0.015000, 0.030000, 1, 1, 1
  );
  ```

- **æ ¸å¿ƒå­—æ®µè¯´æ˜**:
  - `config_type`: æ”¯æŒç³»ç»Ÿçº§ã€ç§Ÿæˆ·çº§ã€ç”¨æˆ·çº§é…ç½®
  - `api_key_encrypted`: åŠ å¯†å­˜å‚¨æ•æ„Ÿçš„APIå¯†é’¥
  - `model_parameters`: JSONå­˜å‚¨çµæ´»çš„æ¨¡å‹å‚æ•°
  - `cost_*`: æ”¯æŒæˆæœ¬è®¡ç®—å’Œè®¡è´¹

- **éªŒæ”¶æ ‡å‡†**:
  - æ”¯æŒå¤šçº§é…ç½®è¦†ç›–(ç³»ç»Ÿ<ç§Ÿæˆ·<ç”¨æˆ·)
  - APIå¯†é’¥å®‰å…¨åŠ å¯†å­˜å‚¨
  - é…ç½®å‚æ•°éªŒè¯æ­£ç¡®
  - é»˜è®¤é…ç½®å”¯ä¸€æ€§çº¦æŸ

- **é¢„è®¡å·¥æ—¶**: 0.5å¤©
- **ä¾èµ–ä»»åŠ¡**: æ— 
- **è¾“å‡ºæ–‡ä»¶**: `server/script/sql/ai_model_config.sql`

---

## ğŸ“Š ç»Ÿè®¡åˆ†æè¡¨ä»»åŠ¡ (D004)

### D004: è®¾è®¡AIä½¿ç”¨ç»Ÿè®¡è¡¨ (ai_usage_statistics)
- **ä»»åŠ¡æè¿°**: è®¾è®¡AIä½¿ç”¨çš„ç»Ÿè®¡åˆ†æè¡¨ï¼Œæ”¯æŒå¤šç»´åº¦çš„ä½¿ç”¨æ•°æ®åˆ†æ
- **è¡¨ç»“æ„è®¾è®¡**:
  ```sql
  CREATE TABLE `ai_usage_statistics` (
    `id` BIGINT NOT NULL AUTO_INCREMENT COMMENT 'ç»Ÿè®¡ID',
    `stat_uuid` VARCHAR(64) NOT NULL COMMENT 'ç»Ÿè®¡UUID',
    `tenant_id` VARCHAR(64) NOT NULL DEFAULT '000000' COMMENT 'ç§Ÿæˆ·ID',
    `user_id` BIGINT DEFAULT NULL COMMENT 'ç”¨æˆ·ID',
    `stat_date` DATE NOT NULL COMMENT 'ç»Ÿè®¡æ—¥æœŸ',
    `stat_hour` TINYINT DEFAULT NULL COMMENT 'ç»Ÿè®¡å°æ—¶(0-23ï¼Œç”¨äºå°æ—¶çº§ç»Ÿè®¡)',
    `model_provider` VARCHAR(32) NOT NULL COMMENT 'æ¨¡å‹æä¾›å•†',
    `model_name` VARCHAR(64) NOT NULL COMMENT 'æ¨¡å‹åç§°',
    `request_count` INT DEFAULT 0 COMMENT 'è¯·æ±‚æ¬¡æ•°',
    `success_count` INT DEFAULT 0 COMMENT 'æˆåŠŸæ¬¡æ•°',
    `error_count` INT DEFAULT 0 COMMENT 'é”™è¯¯æ¬¡æ•°',
    `total_prompt_tokens` BIGINT DEFAULT 0 COMMENT 'æ€»è¾“å…¥Tokenæ•°',
    `total_completion_tokens` BIGINT DEFAULT 0 COMMENT 'æ€»è¾“å‡ºTokenæ•°',
    `total_tokens` BIGINT DEFAULT 0 COMMENT 'æ€»Tokenæ•°',
    `total_cost` DECIMAL(12,6) DEFAULT 0.000000 COMMENT 'æ€»æˆæœ¬',
    `avg_response_time` INT DEFAULT 0 COMMENT 'å¹³å‡å“åº”æ—¶é—´(æ¯«ç§’)',
    `max_response_time` INT DEFAULT 0 COMMENT 'æœ€å¤§å“åº”æ—¶é—´(æ¯«ç§’)',
    `min_response_time` INT DEFAULT 0 COMMENT 'æœ€å°å“åº”æ—¶é—´(æ¯«ç§’)',
    `created_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
    `updated_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ—¶é—´',
    PRIMARY KEY (`id`),
    UNIQUE KEY `uk_stat_uuid` (`stat_uuid`),
    UNIQUE KEY `uk_tenant_user_date_hour_model` (`tenant_id`, `user_id`, `stat_date`, `stat_hour`, `model_provider`, `model_name`),
    KEY `idx_tenant_date` (`tenant_id`, `stat_date`),
    KEY `idx_stat_date` (`stat_date`),
    KEY `idx_model_provider` (`model_provider`, `model_name`)
  ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='AIä½¿ç”¨ç»Ÿè®¡è¡¨';
  
  -- åˆ›å»ºæŒ‰æœˆåˆ†åŒº
  ALTER TABLE ai_usage_statistics 
  PARTITION BY RANGE (TO_DAYS(stat_date)) (
    PARTITION p202501 VALUES LESS THAN (TO_DAYS('2025-02-01')),
    PARTITION p202502 VALUES LESS THAN (TO_DAYS('2025-03-01')),
    PARTITION p202503 VALUES LESS THAN (TO_DAYS('2025-04-01')),
    PARTITION pmax VALUES LESS THAN MAXVALUE
  );
  ```

- **ç»Ÿè®¡ç»´åº¦è§†å›¾**:
  ```sql
  -- ç§Ÿæˆ·æ—¥ç»Ÿè®¡è§†å›¾
  CREATE VIEW v_ai_tenant_daily_stats AS
  SELECT 
    tenant_id,
    stat_date,
    SUM(request_count) as daily_requests,
    SUM(total_tokens) as daily_tokens,
    SUM(total_cost) as daily_cost,
    AVG(avg_response_time) as avg_response_time
  FROM ai_usage_statistics 
  WHERE stat_hour IS NULL
  GROUP BY tenant_id, stat_date;
  
  -- æ¨¡å‹ä½¿ç”¨æ’è¡Œè§†å›¾  
  CREATE VIEW v_ai_model_usage_ranking AS
  SELECT 
    tenant_id,
    model_provider,
    model_name,
    SUM(request_count) as total_requests,
    SUM(total_tokens) as total_tokens,
    SUM(total_cost) as total_cost,
    AVG(avg_response_time) as avg_response_time
  FROM ai_usage_statistics 
  WHERE stat_date >= DATE_SUB(CURDATE(), INTERVAL 30 DAY)
  GROUP BY tenant_id, model_provider, model_name
  ORDER BY total_requests DESC;
  ```

- **æ ¸å¿ƒåŠŸèƒ½**:
  - æ”¯æŒå°æ—¶çº§å’Œæ—¥çº§ç»Ÿè®¡
  - å¤šç§Ÿæˆ·ä½¿ç”¨ç»Ÿè®¡éš”ç¦»
  - æ¨¡å‹ä½¿ç”¨æƒ…å†µåˆ†æ
  - æˆæœ¬ç»Ÿè®¡å’Œé¢„ç®—æ§åˆ¶

- **éªŒæ”¶æ ‡å‡†**:
  - ç»Ÿè®¡æ•°æ®å‡†ç¡®æ— è¯¯
  - æŸ¥è¯¢æ€§èƒ½æ»¡è¶³æŠ¥è¡¨éœ€æ±‚
  - åˆ†åŒºç­–ç•¥æœ‰æ•ˆå‡å°‘æŸ¥è¯¢æ—¶é—´
  - è§†å›¾æä¾›ä¾¿åˆ©çš„æ•°æ®åˆ†æ

- **é¢„è®¡å·¥æ—¶**: 0.5å¤©
- **ä¾èµ–ä»»åŠ¡**: D003
- **è¾“å‡ºæ–‡ä»¶**: `server/script/sql/ai_usage_statistics.sql`

---

## ğŸ” æƒé™é…ç½®è¡¨ä»»åŠ¡ (D005)

### D005: è®¾è®¡AIæƒé™é…ç½®è¡¨ (ai_permission_config)
- **ä»»åŠ¡æè¿°**: è®¾è®¡AIåŠŸèƒ½çš„æƒé™é…ç½®è¡¨ï¼Œé›†æˆRuoYiæƒé™ä½“ç³»
- **è¡¨ç»“æ„è®¾è®¡**:
  ```sql
  CREATE TABLE `ai_permission_config` (
    `id` BIGINT NOT NULL AUTO_INCREMENT COMMENT 'æƒé™é…ç½®ID',
    `config_uuid` VARCHAR(64) NOT NULL COMMENT 'é…ç½®UUID',
    `tenant_id` VARCHAR(64) NOT NULL DEFAULT '000000' COMMENT 'ç§Ÿæˆ·ID',
    `permission_type` VARCHAR(16) NOT NULL COMMENT 'æƒé™ç±»å‹ (role/user/dept)',
    `subject_id` BIGINT NOT NULL COMMENT 'ä¸»ä½“ID(è§’è‰²/ç”¨æˆ·/éƒ¨é—¨ID)',
    `permission_scope` VARCHAR(32) NOT NULL COMMENT 'æƒé™èŒƒå›´ (chat/config/quota/history)',
    `permission_action` VARCHAR(32) NOT NULL COMMENT 'æƒé™åŠ¨ä½œ (view/create/update/delete)',
    `model_providers` JSON DEFAULT NULL COMMENT 'å…è®¸çš„æ¨¡å‹æä¾›å•† ["openai","azure"]',
    `model_names` JSON DEFAULT NULL COMMENT 'å…è®¸çš„æ¨¡å‹åç§° ["gpt-4","gpt-3.5-turbo"]',
    `quota_config` JSON DEFAULT NULL COMMENT 'é…é¢é…ç½®',
    `rate_limit_config` JSON DEFAULT NULL COMMENT 'é™æµé…ç½®',
    `feature_flags` JSON DEFAULT NULL COMMENT 'åŠŸèƒ½å¼€å…³é…ç½®',
    `restrictions` JSON DEFAULT NULL COMMENT 'ä½¿ç”¨é™åˆ¶é…ç½®',
    `enabled` TINYINT DEFAULT 1 COMMENT 'æ˜¯å¦å¯ç”¨ (0:ç¦ç”¨ 1:å¯ç”¨)',
    `effective_start` DATETIME DEFAULT NULL COMMENT 'ç”Ÿæ•ˆå¼€å§‹æ—¶é—´',
    `effective_end` DATETIME DEFAULT NULL COMMENT 'ç”Ÿæ•ˆç»“æŸæ—¶é—´',
    `created_by` BIGINT NOT NULL COMMENT 'åˆ›å»ºè€…',
    `created_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
    `updated_by` BIGINT DEFAULT NULL COMMENT 'æ›´æ–°è€…',
    `updated_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ—¶é—´',
    `deleted` TINYINT DEFAULT 0 COMMENT 'åˆ é™¤æ ‡å¿— (0:æ­£å¸¸ 1:åˆ é™¤)',
    PRIMARY KEY (`id`),
    UNIQUE KEY `uk_config_uuid` (`config_uuid`),
    UNIQUE KEY `uk_tenant_subject_scope_action` (`tenant_id`, `permission_type`, `subject_id`, `permission_scope`, `permission_action`, `deleted`),
    KEY `idx_tenant_type` (`tenant_id`, `permission_type`),
    KEY `idx_subject_id` (`subject_id`),
    KEY `idx_permission_scope` (`permission_scope`, `permission_action`),
    KEY `idx_enabled_effective` (`enabled`, `effective_start`, `effective_end`)
  ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='AIæƒé™é…ç½®è¡¨';
  ```

- **æƒé™é…ç½®ç¤ºä¾‹**:
  ```sql
  -- ç®¡ç†å‘˜è§’è‰²å®Œæ•´æƒé™
  INSERT INTO ai_permission_config (
    config_uuid, tenant_id, permission_type, subject_id,
    permission_scope, permission_action, model_providers, quota_config,
    created_by
  ) VALUES (
    UUID(), '000000', 'role', 1,
    'chat', 'create', '["openai","azure","ollama"]',
    '{"daily_requests": 1000, "monthly_tokens": 1000000, "monthly_cost": 100.00}',
    1
  );
  
  -- æ™®é€šç”¨æˆ·é™åˆ¶æƒé™
  INSERT INTO ai_permission_config (
    config_uuid, tenant_id, permission_type, subject_id,
    permission_scope, permission_action, model_providers, quota_config,
    rate_limit_config, created_by
  ) VALUES (
    UUID(), '000000', 'role', 2,
    'chat', 'create', '["openai"]',
    '{"daily_requests": 50, "monthly_tokens": 50000, "monthly_cost": 10.00}',
    '{"requests_per_minute": 10, "tokens_per_minute": 5000}',
    1
  );
  ```

- **æƒé™æ£€æŸ¥è§†å›¾**:
  ```sql
  CREATE VIEW v_ai_user_permissions AS
  SELECT DISTINCT
    u.user_id,
    u.tenant_id,
    apc.permission_scope,
    apc.permission_action,
    apc.model_providers,
    apc.quota_config,
    apc.rate_limit_config,
    apc.feature_flags
  FROM sys_user u
  LEFT JOIN sys_user_role sur ON u.user_id = sur.user_id
  LEFT JOIN ai_permission_config apc ON (
    (apc.permission_type = 'user' AND apc.subject_id = u.user_id) OR
    (apc.permission_type = 'role' AND apc.subject_id = sur.role_id) OR
    (apc.permission_type = 'dept' AND apc.subject_id = u.dept_id)
  )
  WHERE apc.enabled = 1 
    AND apc.deleted = 0
    AND (apc.effective_start IS NULL OR apc.effective_start <= NOW())
    AND (apc.effective_end IS NULL OR apc.effective_end >= NOW());
  ```

- **æ ¸å¿ƒåŠŸèƒ½**:
  - å¤šä¸»ä½“æƒé™æ§åˆ¶(è§’è‰²/ç”¨æˆ·/éƒ¨é—¨)
  - å¤šç»´åº¦æƒé™ç®¡ç†(åŠŸèƒ½/æ¨¡å‹/é…é¢)
  - æ—¶æ•ˆæ€§æƒé™æ§åˆ¶
  - ä¸RuoYiæƒé™ä½“ç³»é›†æˆ

- **éªŒæ”¶æ ‡å‡†**:
  - æƒé™æ£€æŸ¥é€»è¾‘æ­£ç¡®
  - æ”¯æŒå¤æ‚çš„æƒé™ç»„åˆ
  - æƒé™å˜æ›´å®æ—¶ç”Ÿæ•ˆ
  - æ€§èƒ½æ»¡è¶³æƒé™æ£€æŸ¥éœ€æ±‚

- **é¢„è®¡å·¥æ—¶**: 0.5å¤©
- **ä¾èµ´ä»»åŠ¡**: D004
- **è¾“å‡ºæ–‡ä»¶**: `server/script/sql/ai_permission_config.sql`

---

## ğŸ“‹ éªŒæ”¶æ ‡å‡†

### æ•°æ®å®Œæ•´æ€§éªŒæ”¶
- [ ] æ‰€æœ‰è¡¨ç»“æ„è®¾è®¡åˆç†
- [ ] å¤–é”®çº¦æŸæ­£ç¡®å»ºç«‹
- [ ] ç´¢å¼•è¦†ç›–ä¸»è¦æŸ¥è¯¢åœºæ™¯
- [ ] æ•°æ®ç±»å‹é€‰æ‹©æ°å½“

### å¤šç§Ÿæˆ·éš”ç¦»éªŒæ”¶
- [ ] æ‰€æœ‰è¡¨åŒ…å«tenant_idå­—æ®µ
- [ ] ç§Ÿæˆ·æ•°æ®å®Œå…¨éš”ç¦»
- [ ] è·¨ç§Ÿæˆ·æŸ¥è¯¢è¢«é˜»æ­¢

### æ€§èƒ½éªŒæ”¶
- [ ] å•è¡¨æŸ¥è¯¢å“åº”æ—¶é—´ < 100ms
- [ ] å¤æ‚å…³è”æŸ¥è¯¢å“åº”æ—¶é—´ < 500ms
- [ ] åˆ†åŒºè¡¨åˆ†åŒºç­–ç•¥æœ‰æ•ˆ
- [ ] ç´¢å¼•å‘½ä¸­ç‡ > 90%

### å®‰å…¨æ€§éªŒæ”¶
- [ ] æ•æ„Ÿæ•°æ®åŠ å¯†å­˜å‚¨
- [ ] è½¯åˆ é™¤æœºåˆ¶æ­£å¸¸
- [ ] æƒé™æ£€æŸ¥é€»è¾‘æ­£ç¡®
- [ ] æ•°æ®è®¿é—®å®¡è®¡å®Œæ•´

---

## ğŸ”— è¡¨å…³ç³»å›¾

```mermaid
erDiagram
    ai_chat_session ||--o{ ai_chat_message : "ä¼šè¯åŒ…å«æ¶ˆæ¯"
    ai_chat_session }o--|| ai_model_config : "ä½¿ç”¨æ¨¡å‹é…ç½®"
    ai_chat_message }o--|| ai_usage_statistics : "ç”Ÿæˆä½¿ç”¨ç»Ÿè®¡"
    ai_permission_config ||--o{ ai_chat_session : "æƒé™æ§åˆ¶ä¼šè¯"
    
    ai_chat_session {
        bigint id PK
        varchar session_uuid UK
        varchar tenant_id
        bigint user_id
        varchar session_title
        varchar model_provider
        varchar model_name
        text system_prompt
        json session_config
        int message_count
        int total_tokens
        tinyint status
        datetime created_time
    }
    
    ai_chat_message {
        bigint id PK
        varchar message_uuid UK
        bigint session_id FK
        varchar tenant_id
        bigint user_id
        varchar message_role
        longtext message_content
        int prompt_tokens
        int completion_tokens
        int total_tokens
        varchar model_provider
        varchar model_name
        int response_time
        datetime created_time
    }
    
    ai_model_config {
        bigint id PK
        varchar config_uuid UK
        varchar tenant_id
        varchar config_name
        varchar model_provider
        varchar model_name
        text api_key_encrypted
        json model_parameters
        decimal cost_per_1k_input
        decimal cost_per_1k_output
        tinyint enabled
        tinyint is_default
    }
    
    ai_usage_statistics {
        bigint id PK
        varchar tenant_id
        bigint user_id
        date stat_date
        varchar model_provider
        varchar model_name
        int request_count
        bigint total_tokens
        decimal total_cost
        int avg_response_time
    }
    
    ai_permission_config {
        bigint id PK
        varchar tenant_id
        varchar permission_type
        bigint subject_id
        varchar permission_scope
        varchar permission_action
        json model_providers
        json quota_config
        tinyint enabled
    }
```

---

## ğŸ’¡ è®¾è®¡é‡ç‚¹è¯´æ˜

### å¤šç§Ÿæˆ·è®¾è®¡åŸåˆ™
1. **æ•°æ®éš”ç¦»**: æ¯ä¸ªè¡¨éƒ½åŒ…å«tenant_idå­—æ®µ
2. **æƒé™éš”ç¦»**: é€šè¿‡æƒé™é…ç½®è¡¨æ§åˆ¶ç§Ÿæˆ·å†…æƒé™
3. **é…ç½®éš”ç¦»**: æ”¯æŒç§Ÿæˆ·çº§åˆ«çš„æ¨¡å‹é…ç½®
4. **ç»Ÿè®¡éš”ç¦»**: ç§Ÿæˆ·ä½¿ç”¨æ•°æ®å®Œå…¨åˆ†ç¦»

### æ€§èƒ½ä¼˜åŒ–ç­–ç•¥
1. **åˆ†åŒºè¡¨**: æ¶ˆæ¯è¡¨å’Œç»Ÿè®¡è¡¨æŒ‰æ—¶é—´åˆ†åŒº
2. **ç´¢å¼•ä¼˜åŒ–**: é’ˆå¯¹æŸ¥è¯¢æ¨¡å¼è®¾è®¡å¤åˆç´¢å¼•
3. **è§†å›¾ç®€åŒ–**: æä¾›å¸¸ç”¨æŸ¥è¯¢çš„è§†å›¾
4. **ç¼“å­˜å‹å¥½**: è®¾è®¡æ”¯æŒRedisç¼“å­˜çš„æ•°æ®ç»“æ„

### æ‰©å±•æ€§è€ƒè™‘
1. **JSONå­—æ®µ**: ä½¿ç”¨JSONå­˜å‚¨çµæ´»é…ç½®
2. **UUIDæ ‡è¯†**: å‰ç«¯ä½¿ç”¨UUIDé¿å…IDæš´éœ²
3. **è½¯åˆ é™¤**: æ”¯æŒæ•°æ®æ¢å¤å’Œå®¡è®¡
4. **ç‰ˆæœ¬é¢„ç•™**: ä¸ºæœªæ¥åŠŸèƒ½æ‰©å±•é¢„ç•™å­—æ®µ

---

**ğŸ¯ Phase 1æ•°æ®åº“å®Œæˆæ ‡å¿—**: AIåŸºç¡€è¡¨ç»“æ„å®Œæ•´ï¼Œæ”¯æŒå¤šç§Ÿæˆ·å®‰å…¨éš”ç¦»ï¼Œæ»¡è¶³åŸºæœ¬çš„èŠå¤©ã€é…ç½®ã€ç»Ÿè®¡ã€æƒé™ç®¡ç†éœ€æ±‚